---
title: "NFL Play Selection Dynamics"
subtitle: "A Machine Learning Enhanced Selection Model Analysis"
author: "NFL Analytics Team"
date: "January 31, 2025"
output:
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    code_folding: hide
    highlight: tango
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r options, include=FALSE}
options(max.print=1000000)
```


```{r}
library(data.table)
outcome_data <- fread("predict_outcome.csv.gz")
select_data <- fread("predict_select.csv.gz")
```

```{r, echo=FALSE}
library(dplyr)
library(ggplot2)
library(stringr)
library(tidyr)

# Get year summaries
year_summary <- outcome_data %>%
  select(starts_with("year20")) %>%
  summarise(across(everything(), sum)) %>%
  pivot_longer(everything(), 
               names_to = "variable",
               values_to = "count") %>%
  mutate(year = as.numeric(str_extract(variable, "\\d{4}"))) %>%
  group_by(year) %>%
  summarise(total_attempts = sum(count))

# Get team summaries
team_summary <- outcome_data %>%
  select(starts_with("year20")) %>%
  summarise(across(everything(), sum)) %>%
  pivot_longer(everything(), 
               names_to = "variable",
               values_to = "count") %>%
  mutate(team = str_extract(variable, "team_([A-Z]+)") %>% str_remove("team_")) %>%
  group_by(team) %>%
  summarise(total_attempts = sum(count))

# Plot 1: Attempts by Year
year_plot <- ggplot(year_summary, aes(x = factor(year), y = total_attempts)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  theme_minimal() +
  labs(
    title = "Total Number of Attempts by Year",
    x = "Year",
    y = "Total Attempts",
    caption = "Source: NFL Play Data"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Plot 2: Attempts by Team
team_plot <- ggplot(team_summary, aes(x = reorder(team, -total_attempts), y = total_attempts)) +
  geom_bar(stat = "identity", fill = "darkgreen") +
  theme_minimal() +
  labs(
    title = "Total Number of Attempts by Team",
    x = "Team",
    y = "Total Attempts",
    caption = "Source: NFL Play Data"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
  )

# Display plots side by side
library(gridExtra)
grid.arrange(year_plot, team_plot, ncol = 2)
```


```{r}
select_data[, attempt := as.numeric(as.character(attempt))]
```

# Selection Step

```{r}
library(randomForest)
# Convert attempt to factor
select_data$attempt <- as.factor(select_data$attempt)

# Fit random forest model
rf_model <- randomForest(
  attempt ~ . - my_id,
  data = select_data,
  ntree = 500,
  probability = TRUE
)

# Calculate OOB AUC
library(pROC)
oob_pred <- predict(rf_model, type = "prob")[,2]
oob_auc <- auc(roc(select_data$attempt, oob_pred))
print(paste("OOB AUC:", round(oob_auc, 3)))

# Get probability predictions for GIMR
z <- predict(rf_model, newdata = select_data, type = "prob")[,2]
```


```{r}
# Calculate residuals for RF predictions
y <- as.numeric(as.character(select_data$attempt))
residuals <- y - z

# Histogram of residuals
hist(residuals, main="Distribution of RF Model Residuals", xlab="Residual", breaks=50)
```

```{r}
# plot out the z values\
plot(density(z), 
     main = "Density of Z Predictions",
     xlab = "Predicted Probability of Attempt",
     ylab = "Density")
```

```{r}
# Calculate GIMR (lambda) This is Generalized inverse mills ratio
GIMR <- dnorm(qnorm(z)) / (1 - pnorm(qnorm(z)))

# Add GIMR to the data
select_data[, GIMR := GIMR]

# Print variable importance mdi
imp <- importance(rf_model)

```

```{r}
# Create a data.table with just my_id and GIMR from select_data
GIMR_dt <- data.table(my_id = select_data$my_id, GIMR = GIMR)

# Add GIMR to outcome_data by matching on my_id
outcome_data[GIMR_dt, GIMR := i.GIMR, on = "my_id"]
```

# Outcome Step
```{r}
#kill - my_id
outcome_data <- outcome_data[, my_id := NULL]
outcome_data[, year2017_team_ARI := NULL]
outcome_data[, offense_player_9_weeks_found_12w := NULL]
```


```{r}
outcome_data[, conversion := as.numeric(as.character(conversion))]
# Then run OLS with GIMR correction
ols_model <- lm(conversion ~  ., data = outcome_data)
```


```{r}
library("lmtest")
library("sandwich")

# hetroskedastic adjusted SEs
coeftest(ols_model, vcov = vcovHC(ols_model, type = "HC0"))
```


```{r}
# get vifs
library(car)
vif(ols_model)
```















